# utils/quarto_renderer.py
import subprocess
import tempfile
from pathlib import Path
from typing import Optional, List

class QuartoRenderer:
    """Quarto ë¬¸ì„œ ìƒì„± ë° ë Œë”ë§"""
    
    def __init__(self):
        self.temp_dir = Path(tempfile.mkdtemp())
        
    def create_qmd_document(
        self, 
        title: str,
        author: str,
        experiment_date: str,
        code_chunks: List[dict],
        theme: str = "cosmo",
        code_fold: bool = True,
        output_path: Optional[str] = None
    ) -> Path:
        """Quarto ë¬¸ì„œ ìƒì„±"""
        
        yaml_header = f"""---
title: "{title}"
subtitle: "AI-Powered Bio-Data Analysis Insights"
author: "{author}"
date: "{experiment_date}"
lang: ko
format:
  html:
    theme:
      light: [flatly, custom.scss]
      dark: darkly
    code-fold: {"true" if code_fold else "false"}
    code-tools: true
    code-copy: true
    toc: true
    toc-depth: 3
    toc-location: left
    smooth-scroll: true
    highlight-style: monokai
    number-sections: true
    fig-cap-location: bottom
    margin-left: 20px
    margin-right: 20px
    embed-resources: true
  pdf:
    documentclass: article
    geometry: 
      - margin=1in
    toc: true
    number-sections: true
    colorlinks: true
    mainfont: "NanumGothic"
jupyter: python3
execute:
  warning: false
  message: false
---

```{{css, echo=FALSE}}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono&display=swap');

body {{
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  line-height: 1.6;
}}

.quarto-title-block .quarto-title-banner {{
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  padding-top: 3em;
  padding-bottom: 2em;
  color: white;
}}

.quarto-title-meta {{
  border-top: 1px solid #eee;
  padding-top: 1em;
}}

h2 {{
  border-bottom: 2px solid #3498db;
  padding-bottom: 0.3em;
  margin-top: 1.5em;
  font-weight: 600;
}}

.callout {{
  border-radius: 8px;
  border-left-width: 5px;
}}
```

"""
        
        abstract = f"""

## ì‹¤í—˜ ê°œìš” {{.unnumbered}}

::: {{.grid}}

::: {{.g-col-6}}
- **ì‹¤í—˜ ì œëª©**: {title}
- **ì‹¤í—˜ì**: {author}
- **ì‹¤í—˜ ë‚ ì§œ**: {experiment_date}
:::

::: {{.g-col-6}}
- **ë¶„ì„ ë„êµ¬**: Bio-Log v2.1
- **ì—”ì§„**: Google Gemini 2.5
- **ì´ ë¶„ì„ ìˆ˜**: {len(code_chunks)}ê°œ
:::

:::

---

"""
        
        content = yaml_header + abstract
        
        for i, chunk in enumerate(code_chunks, 1):
            lang = chunk.get('language', 'python')
            code = chunk.get('code', '')
            caption = chunk.get('caption', f'ë¶„ì„ {i}')
            interpretation = chunk.get('interpretation', '')
            
            content += f"""
## ë¶„ì„ {i}: {caption}

"""
            
            content += f"""```{{{lang}}}
#| label: fig-analysis-{i}
#| fig-cap: "{caption}"

{code}
```

"""
            
            if interpretation:
                content += f"""
::: {{.callout-note appearance="simple"}}
### ğŸ’¡ ê²°ê³¼ í•´ì„

{interpretation}
:::

"""
            
            content += "\n---\n\n"
        
        content += """
## ê²°ë¡  ë° ì œì–¸ {.unnumbered}

ë³¸ ë¶„ì„ì€ Google Gemini AIë¥¼ í™œìš©í•˜ì—¬ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 
í†µê³„ì  ê²°ê³¼ëŠ” ì‹¤í—˜ ì„¤ê³„ì™€ ë°ì´í„° í’ˆì§ˆì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
í•­ìƒ ë„ë©”ì¸ ì „ë¬¸ê°€ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.

---

*Generated by Bio-Log - AI-Powered Lab Notebook*
"""
        
        if output_path is None:
            output_path = self.temp_dir / "report.qmd"
        else:
            output_path = Path(output_path)
        
        output_path.parent.mkdir(parents=True, exist_ok=True)
        output_path.write_text(content, encoding='utf-8')
        
        return output_path
    
    def render_to_html(self, qmd_path: Path) -> Path:
        """Quarto ë¬¸ì„œë¥¼ HTMLë¡œ ë Œë”ë§"""
        
        try:
            result = subprocess.run(
                ['quarto', 'render', str(qmd_path), '--to', 'html'],
                capture_output=True,
                text=True,
                check=True,
                timeout=60,
                cwd=str(qmd_path.parent),
                encoding='utf-8',
                errors='replace'
            )
            
            html_path = qmd_path.with_suffix('.html')
            
            if not html_path.exists():
                raise FileNotFoundError(f"ë Œë”ë§ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {html_path}")
            
            return html_path
            
        except subprocess.TimeoutExpired:
            raise RuntimeError("ë Œë”ë§ ì‹œê°„ ì´ˆê³¼ (60ì´ˆ)")
        except subprocess.CalledProcessError as e:
            error_msg = f"Quarto ë Œë”ë§ ì‹¤íŒ¨ (exit code {e.returncode}):\n"
            if e.stdout:
                error_msg += f"--- STDOUT ---\n{e.stdout}\n"
            if e.stderr:
                error_msg += f"--- STDERR ---\n{e.stderr}\n"
            raise RuntimeError(error_msg)
        except FileNotFoundError:
            raise RuntimeError("Quartoê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. https://quarto.org ì—ì„œ ì„¤ì¹˜í•˜ì„¸ìš”.")
    
    def render_to_pdf(self, qmd_path: Path) -> Path:
        """Quarto ë¬¸ì„œë¥¼ PDFë¡œ ë Œë”ë§"""
        
        try:
            result = subprocess.run(
                ['quarto', 'render', str(qmd_path), '--to', 'pdf'],
                capture_output=True,
                text=True,
                check=True,
                timeout=120,
                cwd=str(qmd_path.parent),
                encoding='utf-8',
                errors='replace'
            )
            
            pdf_path = qmd_path.with_suffix('.pdf')
            
            if not pdf_path.exists():
                raise FileNotFoundError(f"PDF ìƒì„± ì‹¤íŒ¨: {pdf_path}")
            
            return pdf_path
            
        except subprocess.CalledProcessError as e:
            if "pdflatex" in e.stderr or "xelatex" in e.stderr:
                raise RuntimeError(
                    "PDF ìƒì„±ì— í•„ìš”í•œ LaTeXê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
                    "TinyTeX ì„¤ì¹˜: quarto install tinytex"
                )
            else:
                error_msg = f"PDF ë Œë”ë§ ì‹¤íŒ¨ (exit code {e.returncode}):\n"
                if e.stdout:
                    error_msg += f"--- STDOUT ---\n{e.stdout}\n"
                if e.stderr:
                    error_msg += f"--- STDERR ---\n{e.stderr}\n"
                raise RuntimeError(error_msg)
